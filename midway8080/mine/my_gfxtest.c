#include <stdio.h>
#include <string.h>

#define LO_CHAR 0x20
#define HI_CHAR 0x5e

char cursor_x;
char cursor_y;

typedef unsigned char byte;
typedef signed char sbyte;
typedef unsigned short word;


__sfr __at (0x6) watchdog_strobe;
byte __at (0x2400) vidmem[224][32]; // 256x224x1 video memory

void main();

void start(){
  __asm
    	LD	SP, #0x2400;
  	DI;
  __endasm;
  
  main();
}

const byte font8x8[HI_CHAR - LO_CHAR + 1][8] = {
  { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 }, { 0x00,0x00,0x00,0x79,0x79,0x00,0x00,0x00 }, { 0x00,0x70,0x70,0x00,0x00,0x70,0x70,0x00 }, { 0x14,0x7f,0x7f,0x14,0x14,0x7f,0x7f,0x14 }, { 0x00,0x12,0x3a,0x6b,0x6b,0x2e,0x24,0x00 }, { 0x00,0x63,0x66,0x0c,0x18,0x33,0x63,0x00 }, { 0x00,0x26,0x7f,0x59,0x59,0x77,0x27,0x05 }, { 0x00,0x00,0x00,0x10,0x30,0x60,0x40,0x00 }, { 0x00,0x00,0x1c,0x3e,0x63,0x41,0x00,0x00 }, { 0x00,0x00,0x41,0x63,0x3e,0x1c,0x00,0x00 }, { 0x08,0x2a,0x3e,0x1c,0x1c,0x3e,0x2a,0x08 }, { 0x00,0x08,0x08,0x3e,0x3e,0x08,0x08,0x00 }, { 0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00 }, { 0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00 }, { 0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00 }, { 0x00,0x01,0x03,0x06,0x0c,0x18,0x30,0x20 }, { 0x00,0x3e,0x7f,0x49,0x51,0x7f,0x3e,0x00 }, { 0x00,0x01,0x11,0x7f,0x7f,0x01,0x01,0x00 }, { 0x00,0x23,0x67,0x45,0x49,0x79,0x31,0x00 }, { 0x00,0x22,0x63,0x49,0x49,0x7f,0x36,0x00 }, { 0x00,0x0c,0x0c,0x14,0x34,0x7f,0x7f,0x04 }, { 0x00,0x72,0x73,0x51,0x51,0x5f,0x4e,0x00 }, { 0x00,0x3e,0x7f,0x49,0x49,0x6f,0x26,0x00 }, { 0x00,0x60,0x60,0x4f,0x5f,0x70,0x60,0x00 }, { 0x00,0x36,0x7f,0x49,0x49,0x7f,0x36,0x00 }, { 0x00,0x32,0x7b,0x49,0x49,0x7f,0x3e,0x00 }, { 0x00,0x00,0x00,0x12,0x12,0x00,0x00,0x00 }, { 0x00,0x00,0x00,0x13,0x13,0x00,0x00,0x00 }, { 0x00,0x08,0x1c,0x36,0x63,0x41,0x41,0x00 }, { 0x00,0x14,0x14,0x14,0x14,0x14,0x14,0x00 }, { 0x00,0x41,0x41,0x63,0x36,0x1c,0x08,0x00 }, { 0x00,0x20,0x60,0x45,0x4d,0x78,0x30,0x00 }, { 0x00,0x3e,0x7f,0x41,0x59,0x79,0x3a,0x00 }, { 0x00,0x1f,0x3f,0x68,0x68,0x3f,0x1f,0x00 }, { 0x00,0x7f,0x7f,0x49,0x49,0x7f,0x36,0x00 }, { 0x00,0x3e,0x7f,0x41,0x41,0x63,0x22,0x00 }, { 0x00,0x7f,0x7f,0x41,0x63,0x3e,0x1c,0x00 }, { 0x00,0x7f,0x7f,0x49,0x49,0x41,0x41,0x00 }, { 0x00,0x7f,0x7f,0x48,0x48,0x40,0x40,0x00 }, { 0x00,0x3e,0x7f,0x41,0x49,0x6f,0x2e,0x00 }, { 0x00,0x7f,0x7f,0x08,0x08,0x7f,0x7f,0x00 }, { 0x00,0x00,0x41,0x7f,0x7f,0x41,0x00,0x00 }, { 0x00,0x02,0x03,0x41,0x7f,0x7e,0x40,0x00 }, { 0x00,0x7f,0x7f,0x1c,0x36,0x63,0x41,0x00 }, { 0x00,0x7f,0x7f,0x01,0x01,0x01,0x01,0x00 }, { 0x00,0x7f,0x7f,0x30,0x18,0x30,0x7f,0x7f }, { 0x00,0x7f,0x7f,0x38,0x1c,0x7f,0x7f,0x00 }, { 0x00,0x3e,0x7f,0x41,0x41,0x7f,0x3e,0x00 }, { 0x00,0x7f,0x7f,0x48,0x48,0x78,0x30,0x00 }, { 0x00,0x3c,0x7e,0x42,0x43,0x7f,0x3d,0x00 }, { 0x00,0x7f,0x7f,0x4c,0x4e,0x7b,0x31,0x00 }, { 0x00,0x32,0x7b,0x49,0x49,0x6f,0x26,0x00 }, { 0x00,0x40,0x40,0x7f,0x7f,0x40,0x40,0x00 }, { 0x00,0x7e,0x7f,0x01,0x01,0x7f,0x7e,0x00 }, { 0x00,0x7c,0x7e,0x03,0x03,0x7e,0x7c,0x00 }, { 0x00,0x7f,0x7f,0x06,0x0c,0x06,0x7f,0x7f }, { 0x00,0x63,0x77,0x1c,0x1c,0x77,0x63,0x00 }, { 0x00,0x70,0x78,0x0f,0x0f,0x78,0x70,0x00 }, { 0x00,0x43,0x47,0x4d,0x59,0x71,0x61,0x00 }, { 0x00,0x00,0x7f,0x7f,0x41,0x41,0x00,0x00 }, { 0x00,0x20,0x30,0x18,0x0c,0x06,0x03,0x01 }, { 0x00,0x00,0x41,0x41,0x7f,0x7f,0x00,0x00 }, { 0x00,0x08,0x18,0x3f,0x3f,0x18,0x08,0x00 }
};

void clrscr(){
  memset(vidmem, 0, sizeof(vidmem));
}

void confscr(){ 
  cursor_x = 0;
  cursor_y = 0;
}

void xorpixel(byte x, byte y){
  byte *dest = &vidmem[x][y >> 3];
  *dest = 0x1 << (y&7);
}

void scrollup(){
  int i; 
  memmove(&vidmem[0][1], &vidmem[0][0], sizeof(vidmem)-1);
  for( i = 0; i < 224; i++){
    vidmem[i][0] = 0x00;  
  }
  
}

void newline(){
  if(cursor_y < 31 ){
    cursor_y++;
  } else {
    scrollup();
  }
}

void drawchar(char ch, byte x, byte y){
  byte i; 
  const byte *sprite = &font8x8[ ch - LO_CHAR ][0];
  byte *dest = &vidmem[x*8][y];
  
  for( i = 0; i < 8; i++ ){
    *dest = *sprite++;
    dest += 32; //because screen is a 28*32 grid duh
  }
}

int putchar(int ch){
  drawchar(ch, cursor_x++, 31 - cursor_y);
  
  switch( ch ){
    case '\n':
      newline();
    case '\r':
      cursor_x = 0;
      return 0;
  }

  if( cursor_x % 31 == 0 ) {
    newline();
    cursor_x = 0;
  }
} 


void drawvline(byte x, byte y1, byte y2){
  static int count = 0;
  
  byte by1 = y1 >> 3;
  byte by2 = y2 >> 3;

  signed char nbytes = by2 - by1;
  byte *dest = &vidmem[x][by1];
  
  
  //printf("C %d; NBYTES = %d\n", count++, nbytes);
  
  *dest++ ^= 0xff << (y1 & 7);
  
  if( nbytes > 0){
    while(--nbytes > 0){
      *dest++ ^= 0xff;;
    }
    
    *dest ^= 0xff >> (~y2 & 7);
  } else {
      *--dest ^= 0xff << ((y2+1)&7); 
  }
}

void maketriangle(){
  byte yoff = 0; byte x = 00;
  short step = 1;
  
  int h = 200;
  for( ; yoff < h ; yoff += step ){
    drawvline(x++, 50, 50 + yoff);
    if( yoff == h/2) step = -1;
  }
}

void main(){
  char C = '0'; 
  short i = 0;
  
  clrscr();
  confscr();
  
  printf("ABSOLUTE IN DOUBT\n");
  
  //drawvline(25, 8, 40)19
  //drawvline(20, 8, 9);
  //drawvline(20, 8, 24);
  maketriangle();
  
  
  for( ; ; ){
    watchdog_strobe = 0;
  }
}

